name: remote-flutter-sharp

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-dotnet:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.100'
      - name: Restore .NET dependencies
        run: dotnet restore RemoteFlutterSharp.sln
      - name: Build .NET solution
        run: dotnet build RemoteFlutterSharp.sln --configuration Release --no-restore

  test-dotnet:
    runs-on: ubuntu-latest
    needs: build-dotnet
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.100'
      - name: Test .NET solution
        run: dotnet test RemoteFlutterSharp.sln --configuration Release --no-build

  build-flutter:
    runs-on: macos-latest
    needs: build-dotnet
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
      - name: Install Flutter dependencies
        run: flutter pub get
        working-directory: flutter/remote_flutter_host
      - name: Run Flutter tests
        run: flutter test
        working-directory: flutter/remote_flutter_host
      - name: Build Flutter macOS app
        run: flutter build macos --release
        working-directory: flutter/remote_flutter_host

  package-artifacts:
    runs-on: ubuntu-latest
    needs:
      - test-dotnet
      - build-flutter
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.100'
      - name: Publish sample server
        run: dotnet publish samples/RemoteFlutterSharp.SampleServer/RemoteFlutterSharp.SampleServer.csproj --configuration Release --output artifacts/server
      - name: Export remote UI assets
        run: dotnet run --project tools/RemoteFlutterSharp.Tools/RemoteFlutterSharp.Tools.csproj -- --output artifacts/remote-ui
      - uses: actions/upload-artifact@v4
        with:
          name: remote-ui-assets
          path: artifacts/

  publish-release:
    runs-on: ubuntu-latest
    needs: package-artifacts
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: actions/download-artifact@v4
        with:
          name: remote-ui-assets
          path: dist
      - uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: RemoteFlutterSharp Release ${{ github.run_number }}
          files: dist/**
